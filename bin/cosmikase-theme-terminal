#!/usr/bin/env bash
# cosmikase-theme-terminal - Reload terminal emulators after theme change
# This script sends reload signals to running terminal emulators
set -euo pipefail

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=bin/cosmikase-lib.sh
source "$SCRIPT_DIR/cosmikase-lib.sh"

usage() {
    echo "Usage: $(basename "$0") [options]"
    echo ""
    echo "Send reload signals to running terminal emulators (kitty, ghostty)."
    echo "These terminals support live config reload via SIGUSR1."
    echo ""
    echo "Options:"
    echo "  --quiet, -q    Suppress output"
    echo "  -h, --help     Show this help message"
    echo ""
    echo "Supported terminals:"
    echo "  - kitty       (SIGUSR1 reload)"
    echo "  - ghostty     (SIGUSR1 reload)"
    echo "  - alacritty   (auto-reload via inotify)"
    echo "  - cosmic-term (auto-reload via inotify)"
}

QUIET=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        --quiet|-q)
            QUIET=true
            shift
            ;;
        *)
            echo "Unknown option: $1" >&2
            usage
            exit 1
            ;;
    esac
done

log "Reloading terminal emulators..."

# Terminals that need SIGUSR1 signal to reload
declare -A SIGNAL_TERMINALS=(
    ["kitty"]="kitty"
    ["ghostty"]="ghostty"
)

# Terminals that auto-reload via inotify (no action needed)
declare -A INOTIFY_TERMINALS=(
    ["alacritty"]="alacritty"
    ["cosmic-term"]="cosmic-term"
)

# Reload signal-based terminals
for name in "${!SIGNAL_TERMINALS[@]}"; do
    process="${SIGNAL_TERMINALS[$name]}"
    if pgrep -x "$process" >/dev/null 2>&1; then
        if pkill -USR1 "$process" 2>/dev/null; then
            log "  - Reloaded $name"
        else
            log "  - Failed to reload $name"
        fi
    else
        log "  - $name not running"
    fi
done

# Note inotify-based terminals
for name in "${!INOTIFY_TERMINALS[@]}"; do
    process="${INOTIFY_TERMINALS[$name]}"
    if pgrep -xf "$process" >/dev/null 2>&1; then
        log "  - $name running (auto-reloads via inotify)"
    fi
done

log "Terminal reload complete!"
