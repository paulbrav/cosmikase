#!/usr/bin/env bash
# omarchy-pop-update - Updates all installed software and system components
set -euo pipefail

echo "==> Starting omarchy-pop system update..."
echo ""

# ------------------------------------------------------------------------------
# System Packages
# ------------------------------------------------------------------------------

echo "==> Updating APT packages..."
sudo apt update
sudo apt full-upgrade -y
sudo apt autoremove -y

if command -v flatpak &>/dev/null; then
    echo ""
    echo "==> Updating Flatpak packages..."
    flatpak update -y
fi

if command -v snap &>/dev/null && systemctl is-active --quiet snapd.service 2>/dev/null; then
    echo ""
    echo "==> Updating Snap packages..."
    sudo snap refresh || true
fi

# ------------------------------------------------------------------------------
# Runtimes & Package Managers
# ------------------------------------------------------------------------------

if command -v rustup &>/dev/null; then
    echo ""
    echo "==> Updating Rust toolchain..."
    rustup update
fi

# uv is required for omarchy-pop tooling - install if missing, then update
if command -v uv &>/dev/null; then
    echo ""
    echo "==> Updating uv and tools..."
    uv self update || echo "  (uv self update not available - may be system-installed)"
    uv tool upgrade --all || true
else
    echo ""
    echo "==> Installing uv (required for omarchy-pop)..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    # Source the new binary for this session
    export PATH="$HOME/.local/bin:$PATH"
    if command -v uv &>/dev/null; then
        echo "  uv installed successfully."
        uv tool upgrade --all || true
    fi
fi

if command -v bun &>/dev/null; then
    echo ""
    echo "==> Updating Bun..."
    bun upgrade
fi

if command -v juliaup &>/dev/null; then
    echo ""
    echo "==> Updating Julia..."
    juliaup update
fi

if command -v npm &>/dev/null; then
    echo ""
    echo "==> Updating global NPM packages..."
    # nvm-installed npm doesn't need sudo
    if [[ "$(npm config get prefix)" == "/usr"* ]]; then
        sudo npm update -g || true
    else
        npm update -g || true
    fi
fi

# ------------------------------------------------------------------------------
# Ghostty (from source)
# ------------------------------------------------------------------------------

GHOSTTY_SOURCE="$HOME/ghostty-source"
LOCAL_BIN="$HOME/.local/bin"

if [[ -d "$GHOSTTY_SOURCE" ]]; then
    echo ""
    echo "==> Updating Ghostty from source..."
    
    # Find zig
    ZIG_CMD=""
    if command -v zig &>/dev/null; then
        ZIG_CMD="zig"
    elif [[ -x /usr/local/bin/zig ]]; then
        ZIG_CMD="/usr/local/bin/zig"
    elif [[ -x /opt/zig-0.13.0/zig ]]; then
        ZIG_CMD="/opt/zig-0.13.0/zig"
    fi
    
    if [[ -n "$ZIG_CMD" ]]; then
        echo "  Pulling latest source..."
        (cd "$GHOSTTY_SOURCE" && git pull)
        
        echo "  Building Ghostty (this may take a few minutes)..."
        if (cd "$GHOSTTY_SOURCE" && "$ZIG_CMD" build -Doptimize=ReleaseFast); then
            mkdir -p "$LOCAL_BIN"
            install -m 755 "$GHOSTTY_SOURCE/zig-out/bin/ghostty" "$LOCAL_BIN/ghostty"
            
            # Update desktop integration
            if [[ -d "$GHOSTTY_SOURCE/zig-out/share" ]]; then
                mkdir -p "$HOME/.local/share"
                cp -r "$GHOSTTY_SOURCE/zig-out/share/"* "$HOME/.local/share/" 2>/dev/null || true
                update-desktop-database "$HOME/.local/share/applications" 2>/dev/null || true
            fi
            echo "  Ghostty updated successfully."
        else
            echo "  Warning: Ghostty build failed. Skipping."
        fi
    else
        echo "  Warning: Zig not found. Cannot rebuild Ghostty."
    fi
fi

# ------------------------------------------------------------------------------
# Firmware
# ------------------------------------------------------------------------------

if command -v fwupdmgr &>/dev/null; then
    echo ""
    echo "==> Checking for firmware updates..."
    sudo fwupdmgr refresh --force 2>/dev/null || true
    sudo fwupdmgr get-updates 2>/dev/null || echo "  No firmware updates available."
    echo "  To install firmware updates, run: sudo fwupdmgr update"
fi

echo ""
echo "==> Update complete!"
