#!/usr/bin/env bash
set -Eeuo pipefail

# This script helps switch power profiles based on AC/Battery state.
# It is intended to be called by udev rules but can also be run manually.

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export PATH

LOG_TAG="omarchy-power"

log() { logger -t "$LOG_TAG" "$*"; }

current_profile() {
  powerprofilesctl get 2>/dev/null || echo "unknown"
}

set_profile() {
  local profile="$1"
  if [[ "$(current_profile)" == "$profile" ]]; then
    return 0
  fi
  if powerprofilesctl set "$profile" 2>/dev/null; then
    log "Set power profile: $profile"
    return 0
  fi
  return 1
}

detect_ac() {
  local dev
  for dev in /sys/class/power_supply/*; do
    [[ -f "$dev/type" ]] || continue
    if grep -q '^Mains$' "$dev/type"; then
      if [[ -r "$dev/online" ]] && [[ "$(cat "$dev/online")" == "1" ]]; then
        return 0
      fi
    fi
  done
  return 1
}

apply_once() {
  if detect_ac; then
    if ! set_profile "performance"; then
      set_profile "balanced" || true
    fi
  else
    set_profile "power-saver" || true
  fi
}

case "${1:---apply}" in
  --ac)
    if ! set_profile "performance"; then
      set_profile "balanced" || true
    fi
    ;;
  --battery)
    set_profile "power-saver" || true
    ;;
  --apply|*)
    apply_once || true
    ;;
esac

