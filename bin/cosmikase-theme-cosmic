#!/usr/bin/env bash
# cosmikase-theme-cosmic - Apply theme to COSMIC desktop
# This script applies theme colors, wallpaper, and terminal settings to COSMIC
set -euo pipefail

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=bin/cosmikase-lib.sh
source "$SCRIPT_DIR/cosmikase-lib.sh"

THEMES_DIR="$(find_themes_dir)"

usage() {
    echo "Usage: $(basename "$0") <theme-name> [options]"
    echo ""
    echo "Apply a theme to COSMIC desktop (wallpaper, colors, terminal, dark/light mode)."
    echo ""
    echo "Options:"
    echo "  --no-wallpaper  Skip wallpaper change"
    echo "  --no-colors     Skip color theme application"
    echo "  --no-terminal   Skip terminal color scheme"
    echo "  --quiet, -q     Suppress output"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  $(basename "$0") catppuccin"
    echo "  $(basename "$0") tokyo-night --no-wallpaper"
}

# Parse arguments
THEME=""
APPLY_WALLPAPER=true
APPLY_COLORS=true
APPLY_TERMINAL=true
QUIET=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        --no-wallpaper)
            APPLY_WALLPAPER=false
            shift
            ;;
        --no-colors)
            APPLY_COLORS=false
            shift
            ;;
        --no-terminal)
            APPLY_TERMINAL=false
            shift
            ;;
        --quiet|-q)
            QUIET=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            usage
            exit 1
            ;;
        *)
            if [[ -z "$THEME" ]]; then
                THEME="$1"
            else
                echo "Error: Multiple theme names provided" >&2
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Require theme
require_theme "$THEME" "$THEMES_DIR" || exit 1

# Check if COSMIC is available
if [[ ! -d "$HOME/.config/cosmic" ]]; then
    log "COSMIC config directory not found, skipping COSMIC theming"
    exit 0
fi

log "Applying COSMIC theme: $THEME"

# Validate RON files before applying
if [[ -f "$THEME_PATH/cosmic.ron" ]]; then
    if ! uv run cosmikase-validate-ron "$THEME_PATH/cosmic.ron" >/dev/null 2>&1; then
        echo "Error: Invalid RON syntax in $THEME_PATH/cosmic.ron" >&2
        exit 1
    fi
fi
if [[ -f "$THEME_PATH/cosmic-term.ron" ]]; then
    if ! uv run cosmikase-validate-ron "$THEME_PATH/cosmic-term.ron" >/dev/null 2>&1; then
        echo "Error: Invalid RON syntax in $THEME_PATH/cosmic-term.ron" >&2
        exit 1
    fi
fi

# Determine if this is a light theme
IS_LIGHT=false
if [[ -f "$THEME_PATH/light.mode" ]]; then
    IS_LIGHT=true
fi

# Atomic update function for COSMIC configs
apply_cosmic_configs() {
    local tmp_dir
    tmp_dir=$(mktemp -d)
    
    # Prepare all files in tmp
    if [[ "$IS_LIGHT" == "true" ]]; then
        echo "false" > "$tmp_dir/is_dark"
    else
        echo "true" > "$tmp_dir/is_dark"
    fi
    
    if [[ "$APPLY_COLORS" == "true" ]] && [[ -f "$THEME_PATH/cosmic.ron" ]]; then
        cp "$THEME_PATH/cosmic.ron" "$tmp_dir/theme"
    fi
    
    if [[ "$APPLY_TERMINAL" == "true" ]] && [[ -f "$THEME_PATH/cosmic-term.ron" ]]; then
        cp "$THEME_PATH/cosmic-term.ron" "$tmp_dir/color_scheme"
    fi

    # Atomic moves to actual config locations
    if command -v cosmic-config >/dev/null 2>&1; then
        log "  - Using cosmic-config CLI..."
        # Note: cosmic-config might not handle all files yet, but it's the future
        # For now we'll use it for mode if possible
        if [[ "$IS_LIGHT" == "true" ]]; then
            cosmic-config set com.system76.CosmicTheme.Mode/v1 is_dark false
        else
            cosmic-config set com.system76.CosmicTheme.Mode/v1 is_dark true
        fi
        log "  - Set COSMIC mode via cosmic-config"
    else
        mkdir -p "$COSMIC_MODE_DIR"
        cp "$tmp_dir/is_dark" "$COSMIC_MODE_DIR/is_dark"
        log "  - Set COSMIC mode via file write"
    fi
    
    if [[ -f "$tmp_dir/theme" ]]; then
        if [[ "$IS_LIGHT" == "true" ]]; then
            COSMIC_THEME_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Light/v1"
        else
            COSMIC_THEME_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Dark/v1"
        fi
        mkdir -p "$COSMIC_THEME_DIR"
        cp "$tmp_dir/theme" "$COSMIC_THEME_DIR/theme"
        log "  - Applied COSMIC color theme"
    fi
    
    if [[ -f "$tmp_dir/color_scheme" ]]; then
        COSMIC_TERM_DIR="$HOME/.config/cosmic/com.system76.CosmicTerm/v1"
        mkdir -p "$COSMIC_TERM_DIR"
        cp "$tmp_dir/color_scheme" "$COSMIC_TERM_DIR/color_scheme"
        log "  - Applied COSMIC terminal color scheme"
    fi

    # Cleanup manually instead of using a trap that might fail at exit
    rm -rf "$tmp_dir"
}

# Set COSMIC paths
COSMIC_MODE_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Mode/v1"

# Execute atomic update
apply_cosmic_configs

# Set COSMIC wallpaper
if [[ "$APPLY_WALLPAPER" == "true" ]] && [[ -d "$THEME_PATH/backgrounds" ]]; then
    WALLPAPER=$(find "$THEME_PATH/backgrounds" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" \) 2>/dev/null | head -1)
    if [[ -n "$WALLPAPER" ]]; then
        WALLPAPER=$(realpath "$WALLPAPER")
        COSMIC_BG_DIR="$HOME/.config/cosmic/com.system76.CosmicBackground/v1"
        mkdir -p "$COSMIC_BG_DIR"
        
        # Write proper RON format for wallpaper config
        cat > "$COSMIC_BG_DIR/all" << EOF
(
    output: "all",
    source: Path("$WALLPAPER"),
    filter_by_theme: false,
    rotation_frequency: 3600,
    filter_method: Lanczos,
    scaling_mode: Zoom,
    sampling_method: Alphanumeric,
)
EOF
        # Remove spurious source file if it exists
        rm -f "$COSMIC_BG_DIR/source"
        log "  - Set COSMIC wallpaper: $(basename "$WALLPAPER")"
    else
        log "  - No wallpaper found in theme"
    fi
fi

# COSMIC uses inotify to watch config files - changes apply automatically
log "COSMIC theme '$THEME' applied successfully!"
log "Note: COSMIC auto-reloads config via inotify"
