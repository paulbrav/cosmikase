#!/usr/bin/env bash
# omarchy-pop-theme-cosmic - Apply theme to COSMIC desktop
# This script applies theme colors, wallpaper, and terminal settings to COSMIC
set -euo pipefail

# Find themes directory - check multiple locations
find_themes_dir() {
    # 1. Environment variable override
    if [[ -n "${THEMES_DIR:-}" ]] && [[ -d "$THEMES_DIR" ]]; then
        echo "$THEMES_DIR"
        return
    fi
    
    # 2. Installed location
    local installed="$HOME/.local/share/omarchy-pop/themes"
    if [[ -d "$installed" ]]; then
        echo "$installed"
        return
    fi
    
    # 3. Repo location (relative to this script)
    local script_dir
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    local repo_themes="$script_dir/../themes"
    if [[ -d "$repo_themes" ]]; then
        echo "$(cd "$repo_themes" && pwd)"
        return
    fi
    
    # 4. Current working directory
    if [[ -d "./themes" ]]; then
        echo "$(cd "./themes" && pwd)"
        return
    fi
    
    # Fallback to default (will fail later with helpful message)
    echo "$HOME/.local/share/omarchy-pop/themes"
}

usage() {
    echo "Usage: $(basename "$0") <theme-name> [options]"
    echo ""
    echo "Apply a theme to COSMIC desktop (wallpaper, colors, terminal, dark/light mode)."
    echo ""
    echo "Options:"
    echo "  --no-wallpaper  Skip wallpaper change"
    echo "  --no-colors     Skip color theme application"
    echo "  --no-terminal   Skip terminal color scheme"
    echo "  --quiet, -q     Suppress output"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  $(basename "$0") catppuccin"
    echo "  $(basename "$0") tokyo-night --no-wallpaper"
}

# Parse arguments
THEME=""
APPLY_WALLPAPER=true
APPLY_COLORS=true
APPLY_TERMINAL=true
QUIET=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        --no-wallpaper)
            APPLY_WALLPAPER=false
            shift
            ;;
        --no-colors)
            APPLY_COLORS=false
            shift
            ;;
        --no-terminal)
            APPLY_TERMINAL=false
            shift
            ;;
        --quiet|-q)
            QUIET=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            usage
            exit 1
            ;;
        *)
            if [[ -z "$THEME" ]]; then
                THEME="$1"
            else
                echo "Error: Multiple theme names provided" >&2
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Require theme argument
if [[ -z "$THEME" ]]; then
    usage
    exit 1
fi

log() {
    if [[ "$QUIET" != "true" ]]; then
        echo "$@"
    fi
}

THEMES_DIR="$(find_themes_dir)"
THEME_PATH="$THEMES_DIR/$THEME"

# Validate theme exists
if [[ ! -d "$THEME_PATH" ]]; then
    echo "Error: Theme '$THEME' not found in $THEMES_DIR" >&2
    exit 1
fi

# Check if COSMIC is available
if [[ ! -d "$HOME/.config/cosmic" ]]; then
    log "COSMIC config directory not found, skipping COSMIC theming"
    exit 0
fi

log "Applying COSMIC theme: $THEME"

# Determine if this is a light theme
IS_LIGHT=false
if [[ -f "$THEME_PATH/light.mode" ]]; then
    IS_LIGHT=true
fi

# Set COSMIC dark/light mode
COSMIC_MODE_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Mode/v1"
mkdir -p "$COSMIC_MODE_DIR"

if [[ "$IS_LIGHT" == "true" ]]; then
    echo "false" > "$COSMIC_MODE_DIR/is_dark"
    log "  - Set COSMIC to Light mode"
else
    echo "true" > "$COSMIC_MODE_DIR/is_dark"
    log "  - Set COSMIC to Dark mode"
fi

# Apply COSMIC color theme
if [[ "$APPLY_COLORS" == "true" ]] && [[ -f "$THEME_PATH/cosmic.ron" ]]; then
    if [[ "$IS_LIGHT" == "true" ]]; then
        COSMIC_THEME_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Light/v1"
    else
        COSMIC_THEME_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Dark/v1"
    fi
    mkdir -p "$COSMIC_THEME_DIR"
    cp "$THEME_PATH/cosmic.ron" "$COSMIC_THEME_DIR/theme"
    log "  - Applied COSMIC color theme"
fi

# Apply COSMIC terminal color scheme
if [[ "$APPLY_TERMINAL" == "true" ]] && [[ -f "$THEME_PATH/cosmic-term.ron" ]]; then
    COSMIC_TERM_DIR="$HOME/.config/cosmic/com.system76.CosmicTerm/v1"
    mkdir -p "$COSMIC_TERM_DIR"
    cp "$THEME_PATH/cosmic-term.ron" "$COSMIC_TERM_DIR/color_scheme"
    log "  - Applied COSMIC terminal color scheme"
fi

# Set COSMIC wallpaper
if [[ "$APPLY_WALLPAPER" == "true" ]] && [[ -d "$THEME_PATH/backgrounds" ]]; then
    WALLPAPER=$(find "$THEME_PATH/backgrounds" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.webp" \) 2>/dev/null | head -1)
    if [[ -n "$WALLPAPER" ]]; then
        WALLPAPER=$(realpath "$WALLPAPER")
        COSMIC_BG_DIR="$HOME/.config/cosmic/com.system76.CosmicBackground/v1"
        mkdir -p "$COSMIC_BG_DIR"
        
        # Write proper RON format for wallpaper config
        cat > "$COSMIC_BG_DIR/all" << EOF
(
    output: "all",
    source: Path("$WALLPAPER"),
    filter_by_theme: false,
    rotation_frequency: 3600,
    filter_method: Lanczos,
    scaling_mode: Zoom,
    sampling_method: Alphanumeric,
)
EOF
        # Remove spurious source file if it exists
        rm -f "$COSMIC_BG_DIR/source"
        log "  - Set COSMIC wallpaper: $(basename "$WALLPAPER")"
    else
        log "  - No wallpaper found in theme"
    fi
fi

# COSMIC uses inotify to watch config files - changes apply automatically
log "COSMIC theme '$THEME' applied successfully!"
log "Note: COSMIC auto-reloads config via inotify"

