#!/usr/bin/env bash
set -euo pipefail

NAME=""
URL=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --name)
      NAME="$2"; shift 2;;
    --url)
      URL="$2"; shift 2;;
    *)
      echo "Usage: $(basename "$0") --name <font name> --url <zip url>" >&2
      exit 1;;
  esac
done

[[ -n "$NAME" && -n "$URL" ]] || { echo "Font name and URL are required" >&2; exit 1; }

FONT_DIR="$HOME/.local/share/fonts"
mkdir -p "$FONT_DIR"

if ls "$FONT_DIR" 2>/dev/null | grep -qi "${NAME// /}"
then
  echo "$NAME already present in $FONT_DIR"
  exit 0
fi

tmpdir=$(mktemp -d)
trap 'rm -rf "$tmpdir"' EXIT

echo "Downloading $NAME..."
curl -fsSLo "$tmpdir/font.zip" "$URL"
unzip -qq "$tmpdir/font.zip" -d "$tmpdir/font" >/dev/null 2>&1 || unzip "$tmpdir/font.zip" -d "$tmpdir/font"

found_fonts=false
# Install TTF
if ls "$tmpdir/font"/*.ttf >/dev/null 2>&1; then
  cp "$tmpdir/font"/*.ttf "$FONT_DIR"
  echo "  - Installed $(ls "$tmpdir/font"/*.ttf | wc -l) TTF files"
  found_fonts=true
fi

# Install OTF
if ls "$tmpdir/font"/*.otf >/dev/null 2>&1; then
  cp "$tmpdir/font"/*.otf "$FONT_DIR"
  echo "  - Installed $(ls "$tmpdir/font"/*.otf | wc -l) OTF files"
  found_fonts=true
fi

if [[ "$found_fonts" == "true" ]]; then
  fc-cache -f > /dev/null 2>&1 || true
else
  echo "Warning: No TTF or OTF files found in zip for $NAME"
fi

rm -rf "$tmpdir"
trap - EXIT
echo "$NAME installed to $FONT_DIR"
