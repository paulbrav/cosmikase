#!/usr/bin/env bash
# omarchy-pop-theme - Switch themes using chezmoi and helper scripts
# This script updates the theme in chezmoi data, reapplies dotfiles, and
# calls per-app helper scripts for live theme updates
set -euo pipefail

# Find script directory for helper scripts
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Find themes directory - check multiple locations
find_themes_dir() {
    # 1. Environment variable override
    if [[ -n "${THEMES_DIR:-}" ]] && [[ -d "$THEMES_DIR" ]]; then
        echo "$THEMES_DIR"
        return
    fi
    
    # 2. Installed location
    local installed="$HOME/.local/share/omarchy-pop/themes"
    if [[ -d "$installed" ]]; then
        echo "$installed"
        return
    fi
    
    # 3. Repo location (relative to this script)
    local repo_themes="$SCRIPT_DIR/../themes"
    if [[ -d "$repo_themes" ]]; then
        echo "$(cd "$repo_themes" && pwd)"
        return
    fi
    
    # 4. Current working directory
    if [[ -d "./themes" ]]; then
        echo "$(cd "./themes" && pwd)"
        return
    fi
    
    # Fallback to default (will fail later with helpful message)
    echo "$HOME/.local/share/omarchy-pop/themes"
}

THEMES_DIR="$(find_themes_dir)"

usage() {
    echo "Usage: $(basename "$0") <theme-name> [options]"
    echo ""
    echo "Switch to a different theme by updating chezmoi data, reapplying dotfiles,"
    echo "and calling per-app helper scripts for live theme updates."
    echo ""
    echo "Options:"
    echo "  --no-cursor     Skip Cursor/VS Code theme update"
    echo "  --no-cosmic     Skip COSMIC desktop theme update"
    echo "  --no-terminals  Skip terminal reload signals"
    echo "  --no-chezmoi    Skip chezmoi apply (only run helper scripts)"
    echo "  --quiet, -q     Suppress output from helper scripts"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "Available themes:"
    if [[ -d "$THEMES_DIR" ]]; then
        for theme in "$THEMES_DIR"/*/; do
            [[ -d "$theme" ]] && echo "  - $(basename "$theme")"
        done
    else
        echo "  (themes directory not found - run 'make install' first)"
    fi
    echo ""
    echo "Examples:"
    echo "  $(basename "$0") nord"
    echo "  $(basename "$0") tokyo-night --no-cursor"
    echo "  $(basename "$0") catppuccin --no-chezmoi  # Only update running apps"
}

# Parse arguments
THEME=""
APPLY_CURSOR=true
APPLY_COSMIC=true
APPLY_TERMINALS=true
APPLY_CHEZMOI=true
QUIET=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            usage
            exit 0
            ;;
        --no-cursor)
            APPLY_CURSOR=false
            shift
            ;;
        --no-cosmic)
            APPLY_COSMIC=false
            shift
            ;;
        --no-terminals)
            APPLY_TERMINALS=false
            shift
            ;;
        --no-chezmoi)
            APPLY_CHEZMOI=false
            shift
            ;;
        --quiet|-q)
            QUIET=true
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            usage
            exit 1
            ;;
        *)
            if [[ -z "$THEME" ]]; then
                THEME="$1"
            else
                echo "Error: Multiple theme names provided" >&2
                usage
                exit 1
            fi
            shift
            ;;
    esac
done

# Require theme argument
if [[ -z "$THEME" ]]; then
    usage
    exit 1
fi

THEME_PATH="$THEMES_DIR/$THEME"

# Validate theme exists
if [[ ! -d "$THEME_PATH" ]]; then
    echo "Error: Theme '$THEME' not found in $THEMES_DIR" >&2
    echo "" >&2
    echo "Available themes:" >&2
    if [[ -d "$THEMES_DIR" ]]; then
        for t in "$THEMES_DIR"/*/; do
            [[ -d "$t" ]] && echo "  - $(basename "$t")" >&2
        done
    fi
    exit 1
fi

echo "Switching to theme: $THEME"

# Step 1: Update chezmoi and apply dotfiles
if [[ "$APPLY_CHEZMOI" == "true" ]]; then
    # Check if chezmoi is available
    if ! command -v chezmoi >/dev/null 2>&1; then
        echo "Error: chezmoi not found. Please install chezmoi first." >&2
        echo "  curl -sfL https://get.chezmoi.io | sh" >&2
        exit 1
    fi

    # Update chezmoi data with new theme
    # chezmoi stores data in ~/.config/chezmoi/chezmoi.toml
    CHEZMOI_CONFIG="$HOME/.config/chezmoi/chezmoi.toml"

    if [[ -f "$CHEZMOI_CONFIG" ]]; then
        # Update existing config
        if grep -q '^\[data\]' "$CHEZMOI_CONFIG"; then
            # Update theme in existing [data] section
            if grep -q '^[[:space:]]*theme[[:space:]]*=' "$CHEZMOI_CONFIG"; then
                sed -i "s/^[[:space:]]*theme[[:space:]]*=.*/    theme = \"$THEME\"/" "$CHEZMOI_CONFIG"
            else
                # Add theme to [data] section
                sed -i "/^\[data\]/a\\    theme = \"$THEME\"" "$CHEZMOI_CONFIG"
            fi
            # Update themes_dir to match the actual location
            if grep -q '^[[:space:]]*themes_dir[[:space:]]*=' "$CHEZMOI_CONFIG"; then
                sed -i "s|^[[:space:]]*themes_dir[[:space:]]*=.*|    themes_dir = \"$THEMES_DIR\"|" "$CHEZMOI_CONFIG"
            else
                sed -i "/^\[data\]/a\\    themes_dir = \"$THEMES_DIR\"" "$CHEZMOI_CONFIG"
            fi
        else
            # Add [data] section
            echo "" >> "$CHEZMOI_CONFIG"
            echo "[data]" >> "$CHEZMOI_CONFIG"
            echo "    theme = \"$THEME\"" >> "$CHEZMOI_CONFIG"
            echo "    themes_dir = \"$THEMES_DIR\"" >> "$CHEZMOI_CONFIG"
        fi
    else
        # Create new config
        mkdir -p "$(dirname "$CHEZMOI_CONFIG")"
        cat > "$CHEZMOI_CONFIG" << EOF
[data]
    theme = "$THEME"
    themes_dir = "$THEMES_DIR"
    font_family = "JetBrainsMono Nerd Font"
    font_size = 9
    padding = 14
EOF
    fi

    echo "  - Updated chezmoi configuration"

    # Reapply dotfiles with new theme
    echo "  - Applying dotfiles..."
    chezmoi apply --force
fi

# Step 2: Call helper scripts for live app updates
echo ""
echo "Updating applications..."

# Helper script arguments
HELPER_ARGS=("$THEME")
if [[ "$QUIET" == "true" ]]; then
    HELPER_ARGS+=("--quiet")
fi

# Find helper script (check script dir first, then PATH)
find_helper() {
    local name="$1"
    if [[ -x "$SCRIPT_DIR/$name" ]]; then
        echo "$SCRIPT_DIR/$name"
    elif command -v "$name" >/dev/null 2>&1; then
        command -v "$name"
    else
        echo ""
    fi
}

# Apply Cursor/VS Code theme
if [[ "$APPLY_CURSOR" == "true" ]]; then
    CURSOR_HELPER=$(find_helper "omarchy-pop-theme-cursor")
    if [[ -n "$CURSOR_HELPER" ]]; then
        echo "  - Applying Cursor theme..."
        THEMES_DIR="$THEMES_DIR" "$CURSOR_HELPER" "${HELPER_ARGS[@]}" || true
    else
        echo "  - Warning: omarchy-pop-theme-cursor not found"
    fi
fi

# Apply COSMIC desktop theme
if [[ "$APPLY_COSMIC" == "true" ]]; then
    COSMIC_HELPER=$(find_helper "omarchy-pop-theme-cosmic")
    if [[ -n "$COSMIC_HELPER" ]]; then
        echo "  - Applying COSMIC theme..."
        THEMES_DIR="$THEMES_DIR" "$COSMIC_HELPER" "${HELPER_ARGS[@]}" || true
    else
        echo "  - Warning: omarchy-pop-theme-cosmic not found"
    fi
fi

# Reload terminal emulators
if [[ "$APPLY_TERMINALS" == "true" ]]; then
    TERMINAL_HELPER=$(find_helper "omarchy-pop-theme-terminal")
    if [[ -n "$TERMINAL_HELPER" ]]; then
        echo "  - Reloading terminals..."
        if [[ "$QUIET" == "true" ]]; then
            "$TERMINAL_HELPER" --quiet || true
        else
            "$TERMINAL_HELPER" || true
        fi
    else
        echo "  - Warning: omarchy-pop-theme-terminal not found"
    fi
fi

echo ""
echo "Theme '$THEME' applied successfully!"
