# Dotfiles role: Install and apply dotfiles using chezmoi
---
# ============================================================================
# Install chezmoi
# ============================================================================

- name: Check if chezmoi is installed
  ansible.builtin.command:
    cmd: which chezmoi
  register: chezmoi_check
  changed_when: false
  failed_when: chezmoi_check.rc > 1

- name: Download chezmoi installer
  ansible.builtin.get_url:
    url: https://get.chezmoi.io
    dest: /tmp/chezmoi-install.sh
    mode: "0755"
  when: chezmoi_check.rc != 0

- name: Install chezmoi
  ansible.builtin.command:
    cmd: /tmp/chezmoi-install.sh -b {{ local_bin }}
  when: chezmoi_check.rc != 0

- name: Clean up chezmoi installer
  ansible.builtin.file:
    path: /tmp/chezmoi-install.sh
    state: absent
  when: chezmoi_check.rc != 0

# ============================================================================
# Sync themes
# ============================================================================

- name: Create themes directory
  ansible.builtin.file:
    path: "{{ themes_dir }}"
    state: directory
    mode: "0755"

- name: Sync themes from repository
  ansible.posix.synchronize:
    src: "{{ playbook_dir }}/../themes/"
    dest: "{{ themes_dir }}/"
    recursive: true
    delete: false
  delegate_to: localhost

# ============================================================================
# Install bin scripts
# ============================================================================

- name: Create local bin directory
  ansible.builtin.file:
    path: "{{ local_bin }}"
    state: directory
    mode: "0755"

- name: Create local share directory
  ansible.builtin.file:
    path: "{{ local_share }}"
    state: directory
    mode: "0755"

- name: Create applications directory
  ansible.builtin.file:
    path: "{{ local_share }}/applications"
    state: directory
    mode: "0755"

- name: Install all cosmikase bin scripts
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../bin/{{ item }}"
    dest: "{{ local_bin }}/{{ item }}"
    mode: "0755"
    remote_src: true
  loop:
    # Core library (sourced by other scripts)
    - cosmikase-lib.sh
    # Theme system
    - cosmikase-theme
    - cosmikase-theme-cosmic
    - cosmikase-theme-cursor
    - cosmikase-theme-terminal
    # System management
    - cosmikase
    - cosmikase-install
    - cosmikase-databases
    - cosmikase-update
    - cosmikase-power-helper
    - cosmikase-cursor-extensions

# ============================================================================
# Initialize and apply chezmoi
# ============================================================================

- name: Create chezmoi config directory
  ansible.builtin.file:
    path: "{{ config_dir }}/chezmoi"
    state: directory
    mode: "0755"

- name: Configure chezmoi with theme data
  ansible.builtin.copy:
    content: |
      sourceDir = "{{ playbook_dir }}/../chezmoi"

      [data]
          theme = "{{ defaults.theme | default('nord') }}"
          themes_dir = "{{ themes_dir }}"
          font_family = "JetBrainsMono Nerd Font"
          font_size = 9
          padding = 14
    dest: "{{ config_dir }}/chezmoi/chezmoi.toml"
    mode: "0644"

- name: Initialize chezmoi with source directory
  ansible.builtin.command:
    cmd: "{{ local_bin }}/chezmoi init --source={{ playbook_dir }}/../chezmoi --apply=false"
  args:
    creates: "{{ local_share }}/chezmoi/.chezmoi.toml.tmpl"
  environment:
    PATH: "{{ local_bin }}:{{ ansible_env.PATH }}"

- name: Apply chezmoi dotfiles
  ansible.builtin.command:
    cmd: "{{ local_bin }}/chezmoi apply --force"
  environment:
    PATH: "{{ local_bin }}:{{ ansible_env.PATH }}"
  register: chezmoi_apply
  # chezmoi manages its own state; always succeeds means changes were applied as needed
  changed_when: false

# ============================================================================
# Shell integration
# ============================================================================

- name: Check if .bashrc exists
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.bashrc"
  register: bashrc_stat

- name: Add cosmikase to .bashrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.bashrc"
    marker: "# {mark} COSMIKASE MANAGED BLOCK"
    block: |
      # cosmikase
      export PATH="{{ local_bin }}:$PATH"
      export TERMINAL="{{ 'ghostty' if defaults.ghostty | default(true) else 'kitty' }}"
      [ -f "{{ config_dir }}/shell/cosmikase.sh" ] && source "{{ config_dir }}/shell/cosmikase.sh"
    create: true
    mode: "0644"
  when: bashrc_stat.stat.exists or true

- name: Check if .zshrc exists
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.zshrc"
  register: zshrc_stat

- name: Add cosmikase to .zshrc
  ansible.builtin.blockinfile:
    path: "{{ ansible_env.HOME }}/.zshrc"
    marker: "# {mark} COSMIKASE MANAGED BLOCK"
    block: |
      # cosmikase
      export PATH="{{ local_bin }}:$PATH"
      export TERMINAL="{{ 'ghostty' if defaults.ghostty | default(true) else 'kitty' }}"
      [ -f "{{ config_dir }}/shell/cosmikase.sh" ] && source "{{ config_dir }}/shell/cosmikase.sh"
    create: false
    mode: "0644"
  when: zshrc_stat.stat.exists

# ============================================================================
# Install theme-tui
# ============================================================================

- name: Check if uv is available
  ansible.builtin.stat:
    path: "{{ local_bin }}/uv"
  register: uv_stat

- name: Install theme-tui via uv
  ansible.builtin.command:
    cmd: "{{ local_bin }}/uv tool install --reinstall {{ playbook_dir }}/.."
  environment:
    PATH: "{{ local_bin }}:{{ ansible_env.PATH }}"
  when: uv_stat.stat.exists
  register: theme_tui_install
  changed_when: "'Installed' in theme_tui_install.stdout"

# ============================================================================
# Install Cursor/VS Code extensions
# ============================================================================

- name: Check if cursor command is available
  ansible.builtin.command:
    cmd: which cursor
  register: cursor_check
  changed_when: false
  failed_when: false

- name: Check if code command is available
  ansible.builtin.command:
    cmd: which code
  register: code_check
  changed_when: false
  failed_when: false
  when: cursor_check.rc != 0

- name: Set editor command
  ansible.builtin.set_fact:
    editor_cmd: "{{ 'cursor' if cursor_check.rc == 0 else ('code' if code_check.rc | default(1) == 0 else '') }}"

- name: Install Cursor/VS Code extensions
  ansible.builtin.shell: |
    set -e
    EXTENSIONS_FILE="{{ config_dir }}/Cursor/extensions.txt"
    if [[ ! -f "$EXTENSIONS_FILE" ]]; then
      echo "Extensions file not found: $EXTENSIONS_FILE"
      exit 0
    fi
    grep -v '^\s*#' "$EXTENSIONS_FILE" | grep -v '^\s*$' | while read -r ext; do
      {{ editor_cmd }} --install-extension "$ext" --force 2>/dev/null || true
    done
  args:
    executable: /bin/bash
  environment:
    PATH: "{{ local_bin }}:{{ ansible_env.PATH }}"
  when: editor_cmd != ''
  register: extensions_install
  changed_when: false
  # Extensions installation is best-effort; some may fail if not available

