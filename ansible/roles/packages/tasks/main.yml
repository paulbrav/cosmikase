# Packages role: Install apt packages and Flatpak applications
---
# ============================================================================
# APT Packages
# ============================================================================

- name: Install core apt packages
  become: true
  ansible.builtin.apt:
    name: "{{ apt.core | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | map(attribute='name') | list + apt.core | default([]) | rejectattr('install', 'defined') | map(attribute='name') | list }}"
    state: present
  when: apt.core is defined and apt.core | length > 0

- name: Install GUI apt packages
  become: true
  ansible.builtin.apt:
    name: "{{ apt.gui | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | map(attribute='name') | list + apt.gui | default([]) | rejectattr('install', 'defined') | map(attribute='name') | list }}"
    state: present
  when: apt.gui is defined and apt.gui | length > 0

- name: Install terminal apt packages (excluding ghostty)
  become: true
  ansible.builtin.apt:
    name: "{{ apt.terminal | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | rejectattr('name', 'equalto', 'ghostty') | map(attribute='name') | list + apt.terminal | default([]) | rejectattr('install', 'defined') | rejectattr('name', 'equalto', 'ghostty') | map(attribute='name') | list }}"
    state: present
  when: apt.terminal is defined and apt.terminal | length > 0

- name: Install system apt packages (containers, gaming)
  become: true
  ansible.builtin.apt:
    name: "{{ apt.system | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | map(attribute='name') | list + apt.system | default([]) | rejectattr('install', 'defined') | map(attribute='name') | list }}"
    state: present
  when: apt.system is defined and apt.system | length > 0

- name: Install YubiKey packages
  become: true
  ansible.builtin.apt:
    name: "{{ apt.yubikey | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | map(attribute='name') | list + apt.yubikey | default([]) | rejectattr('install', 'defined') | map(attribute='name') | list }}"
    state: present
  when:
    - defaults.yubikey_setup | default(false)
    - apt.yubikey is defined and apt.yubikey | length > 0

# ============================================================================
# Flatpak
# ============================================================================

- name: Ensure flatpak is installed
  become: true
  ansible.builtin.apt:
    name: flatpak
    state: present

- name: Add Flathub remote
  community.general.flatpak_remote:
    name: flathub
    flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
    state: present

- name: Install Flatpak applications (parallel)
  community.general.flatpak:
    name: "{{ item.id }}"
    state: present
  loop: "{{ flatpak.apps | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + flatpak.apps | default([]) | rejectattr('install', 'defined') | list }}"
  when: flatpak.apps is defined
  loop_control:
    label: "{{ item.id }}"
  async: 300
  poll: 0
  register: flatpak_jobs

- name: "â³ Waiting for Flatpak installs (retries are normal, not errors)"
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ flatpak_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.id | default('unknown') }}"
  register: flatpak_results
  until: flatpak_results.finished
  retries: 60
  delay: 5
  when: item.ansible_job_id is defined

# ============================================================================
# NPM Global Packages
# ============================================================================

- name: Install npm global packages
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    if ! npm list -g {{ item.name }} --depth=0 >/dev/null 2>&1; then
      npm install -g {{ item.name }}@{{ item.version | default('latest') }}
      echo "installed"
    else
      echo "already installed"
    fi
  args:
    executable: /bin/bash
  loop: "{{ npm | default([]) }}"
  when:
    - npm is defined
    - item.install | default(true)
  loop_control:
    label: "{{ item.name }}"
  register: npm_install
  changed_when: "'installed' in npm_install.stdout"

# ============================================================================
# Fonts
# ============================================================================

- name: Ensure unzip is installed for font extraction
  become: true
  ansible.builtin.apt:
    name: unzip
    state: present

- name: Create fonts directory
  ansible.builtin.file:
    path: "{{ local_share }}/fonts"
    state: directory
    mode: "0755"

- name: Download and install Nerd Fonts
  ansible.builtin.unarchive:
    src: "{{ item.url }}"
    dest: "{{ local_share }}/fonts"
    remote_src: true
    creates: "{{ local_share }}/fonts/JetBrainsMonoNerdFont-Regular.ttf"
  loop: "{{ fonts.nerd | default([]) }}"
  when:
    - fonts.nerd is defined
    - item.install | default(true)
  loop_control:
    label: "{{ item.name }}"

- name: Refresh font cache
  ansible.builtin.command:
    cmd: fc-cache -f
  changed_when: false

