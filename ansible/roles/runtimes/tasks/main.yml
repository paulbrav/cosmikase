# Runtimes role: Install development runtimes (Rust, Bun, uv, nvm, Starship, Julia, Go, Zig)
# Also installs cargo_tools (zellij) and go_tools (gum, lazygit, lazydocker)
---
- name: Set runtimes list
  ansible.builtin.set_fact:
    runtimes_enabled: "{{ installers.runtimes | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + installers.runtimes | default([]) | rejectattr('install', 'defined') | list }}"

# ============================================================================
# Runtime definitions - data-driven installation
# ============================================================================

- name: Define runtime install specs
  ansible.builtin.set_fact:
    runtimes_specs:
      rust:
        check_path: "{{ ansible_env.HOME }}/.cargo/bin/rustc"
        installer_url: https://static.rust-lang.org/rustup/dist/x86_64-unknown-linux-gnu/rustup-init
        installer_dest: /tmp/rustup-init
        install_cmd: /tmp/rustup-init -y
        checksum: "sha256:https://static.rust-lang.org/rustup/dist/x86_64-unknown-linux-gnu/rustup-init.sha256"
      bun:
        check_path: "{{ ansible_env.HOME }}/.bun/bin/bun"
        installer_url: https://bun.sh/install
        installer_dest: /tmp/bun-install.sh
        install_cmd: /tmp/bun-install.sh
      uv:
        check_path: "{{ local_bin }}/uv"
        installer_url: https://astral.sh/uv/install.sh
        installer_dest: /tmp/uv-install.sh
        install_cmd: /tmp/uv-install.sh
      nvm:
        check_path: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
        installer_url: https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh
        installer_dest: /tmp/nvm-install.sh
        install_cmd: /tmp/nvm-install.sh
      starship:
        check_path: "{{ local_bin }}/starship"
        installer_url: https://starship.rs/install.sh
        installer_dest: /tmp/starship-install.sh
        install_cmd: "/tmp/starship-install.sh -y -b {{ local_bin }}"
      julia:
        check_path: ""  # Uses which instead
        check_cmd: julia
        installer_url: https://install.julialang.org
        installer_dest: /tmp/julia-install.sh
        install_cmd: /tmp/julia-install.sh -y
      go:
        check_path: /usr/local/go/bin/go
        installer_url: https://go.dev/dl/go1.24.4.linux-amd64.tar.gz
        installer_dest: /tmp/go.tar.gz
        install_cmd: ""  # Custom handling required
      zig:
        check_path: /usr/local/bin/zig
        installer_url: https://ziglang.org/download/0.15.2/zig-x86_64-linux-0.15.2.tar.xz
        installer_dest: /tmp/zig.tar.xz
        install_dir: /opt/zig-0.15.2
        install_cmd: ""  # Custom handling required

# ============================================================================
# Install runtimes using data-driven loop
# ============================================================================

- name: Install script-based runtimes
  ansible.builtin.include_tasks: install_runtime.yml
  loop: "{{ runtimes_enabled | map(attribute='name') | list }}"
  loop_control:
    loop_var: runtime_name
  when:
    - runtime_name in runtimes_specs
    - runtime_name not in ['go', 'zig']

# ============================================================================
# Go installation (custom handling - extracts tarball)
# ============================================================================

- name: Check if Go is installed
  ansible.builtin.stat:
    path: /usr/local/go/bin/go
  register: runtimes_go_installed

- name: Install Go
  when:
    - runtimes_enabled | selectattr('name', 'equalto', 'go') | list | length > 0
    - not runtimes_go_installed.stat.exists
  block:
    - name: Download Go tarball
      ansible.builtin.get_url:
        url: https://go.dev/dl/go1.24.4.linux-amd64.tar.gz
        dest: /tmp/go.tar.gz
        mode: "0644"

    - name: Remove existing Go installation
      become: true
      ansible.builtin.file:
        path: /usr/local/go
        state: absent

    - name: Extract Go to /usr/local
      become: true
      ansible.builtin.unarchive:
        src: /tmp/go.tar.gz
        dest: /usr/local
        remote_src: true

    - name: Clean up Go tarball
      ansible.builtin.file:
        path: /tmp/go.tar.gz
        state: absent

# ============================================================================
# Zig installation (custom handling - extracts tarball)
# ============================================================================

- name: Check if Zig is installed
  ansible.builtin.stat:
    path: /usr/local/bin/zig
  register: runtimes_zig_installed

- name: Install Zig
  when:
    - runtimes_enabled | selectattr('name', 'equalto', 'zig') | list | length > 0
    - not runtimes_zig_installed.stat.exists
  block:
    - name: Download Zig tarball
      ansible.builtin.get_url:
        url: https://ziglang.org/download/0.15.2/zig-x86_64-linux-0.15.2.tar.xz
        dest: /tmp/zig.tar.xz
        mode: "0644"

    - name: Remove existing Zig installation
      become: true
      ansible.builtin.file:
        path: /opt/zig-0.15.2
        state: absent

    - name: Create Zig installation directory
      become: true
      ansible.builtin.file:
        path: /opt/zig-0.15.2
        state: directory
        mode: "0755"

    - name: Extract Zig to /opt
      become: true
      ansible.builtin.unarchive:
        src: /tmp/zig.tar.xz
        dest: /opt/zig-0.15.2
        remote_src: true
        extra_opts:
          - --strip-components=1

    - name: Remove old Zig symlink
      become: true
      ansible.builtin.file:
        path: /usr/local/bin/zig
        state: absent

    - name: Create Zig symlink
      become: true
      ansible.builtin.file:
        src: /opt/zig-0.15.2/zig
        dest: /usr/local/bin/zig
        state: link

    - name: Clean up Zig tarball
      ansible.builtin.file:
        path: /tmp/zig.tar.xz
        state: absent

# ============================================================================
# Cargo tools (Rust-based CLI tools) - Parallel installation
# ============================================================================

- name: Install cargo tools (parallel)
  ansible.builtin.shell: |
    source {{ ansible_env.HOME }}/.cargo/env
    if ! command -v {{ item.name }} &>/dev/null; then
      cargo install --locked {{ item.name }}
      echo "installed"
    else
      echo "already installed"
    fi
  args:
    executable: /bin/bash
  loop: "{{ cargo_tools | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + cargo_tools | default([]) | rejectattr('install', 'defined') | list }}"
  when:
    - cargo_tools is defined and cargo_tools | length > 0
    - runtimes_enabled | selectattr('name', 'equalto', 'rust') | list | length > 0
  loop_control:
    label: "{{ item.name }}"
  async: 600
  poll: 0
  register: runtimes_cargo_jobs
  changed_when: false

- name: "⏳ Waiting for cargo tools to compile (retries are normal, not errors)"
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ runtimes_carruntimes_go_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name | default('unknown') }}"
  register: runtimes_carruntimes_go_results
  until: runtimes_carruntimes_go_results.finished
  retries: 120
  delay: 5
  when: item.ansible_job_id is defined

# ============================================================================
# Go tools (Go-based CLI tools) - Parallel installation
# ============================================================================

- name: Install go tools (parallel)
  ansible.builtin.shell: |
    export PATH="/usr/local/go/bin:{{ ansible_env.HOME }}/go/bin:$PATH"
    if ! command -v {{ item.name }} &>/dev/null; then
      go install {{ item.package }}
      echo "installed"
    else
      echo "already installed"
    fi
  args:
    executable: /bin/bash
  loop: "{{ go_tools | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + go_tools | default([]) | rejectattr('install', 'defined') | list }}"
  when:
    - go_tools is defined and go_tools | length > 0
    - runtimes_enabled | selectattr('name', 'equalto', 'go') | list | length > 0 or runtimes_go_installed.stat.exists
  loop_control:
    label: "{{ item.name }}"
  async: 300
  poll: 0
  register: runtimes_go_jobs
  changed_when: false

- name: "⏳ Waiting for go tools to install (retries are normal, not errors)"
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ runtimes_go_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name | default('unknown') }}"
  register: runtimes_go_results
  until: runtimes_go_results.finished
  retries: 60
  delay: 5
  when: item.ansible_job_id is defined

# ============================================================================
# Post-install: Node.js LTS via nvm
# ============================================================================

- name: Install Node.js LTS via nvm
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install --lts
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.nvm/versions/node"
  when:
    - runtimes_enabled | selectattr('name', 'equalto', 'nvm') | list | length > 0

# ============================================================================
# uv tools (Python CLI tools) - Parallel installation
# ============================================================================

- name: Install uv tools (parallel)
  ansible.builtin.shell: |
    {{ local_bin }}/uv tool install {{ item.name }}
  loop: "{{ uv_tools | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | rejectattr('name', 'equalto', 'mojo') | list + uv_tools | default([]) | rejectattr('install', 'defined') | rejectattr('name', 'equalto', 'mojo') | list }}"
  when: uv_tools is defined and uv_tools | length > 0
  loop_control:
    label: "{{ item.name }}"
  async: 120
  poll: 0
  register: runtimes_uv_jobs
  changed_when: false

- name: "⏳ Waiting for uv tools to install (retries are normal, not errors)"
  ansible.builtin.async_status:
    jid: "{{ item.ansible_job_id }}"
  loop: "{{ runtimes_uv_jobs.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name | default('unknown') }}"
  register: runtimes_uv_results
  until: runtimes_uv_results.finished
  retries: 30
  delay: 4
  when: item.ansible_job_id is defined

- name: Install Mojo via uv (requires Modular index)
  ansible.builtin.shell: |
    {{ local_bin }}/uv tool install mojo --index-url https://modular.gateway.scarf.sh/simple/ --index-strategy unsafe-best-match
  when:
    - uv_tools is defined
    - uv_tools | selectattr('name', 'equalto', 'mojo') | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list | length > 0 or
      uv_tools | selectattr('name', 'equalto', 'mojo') | rejectattr('install', 'defined') | list | length > 0
  register: runtimes_mojo_result
  changed_when: "'Installed' in runtimes_mojo_result.stdout"
  failed_when: false

# ============================================================================
# npm global packages
# ============================================================================

- name: Check if npm is available
  ansible.builtin.command:
    cmd: which npm
  register: runtimes_npm_check
  changed_when: false
  failed_when: runtimes_npm_check.rc > 1

- name: Check if nvm is installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
  register: runtimes_nvm_installed

- name: Install npm global packages
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    if ! npm list -g {{ item.name }} --depth=0 >/dev/null 2>&1; then
      npm install -g {{ item.name }}{% if item.version is defined %}@{{ item.version }}{% endif %}

      echo "installed"
    else
      echo "already installed"
    fi
  args:
    executable: /bin/bash
  loop: "{{ npm_packages }}"
  when:
    - npm_packages is defined and npm_packages | length > 0
    - item.install | default(true)
    - runtimes_npm_check.rc == 0 or runtimes_nvm_installed.stat.exists
  loop_control:
    label: "{{ item.name }}"
  register: runtimes_npm_result
  changed_when: "'installed' in runtimes_npm_result.stdout"
