# Runtimes role: Install development runtimes (Rust, Bun, uv, nvm, Starship, Julia)
---
- name: Set runtimes list
  ansible.builtin.set_fact:
    enabled_runtimes: "{{ installers.runtimes | default([]) | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list + installers.runtimes | default([]) | rejectattr('install', 'defined') | list }}"

# ============================================================================
# Runtime definitions - data-driven installation
# ============================================================================

- name: Define runtime install specs
  ansible.builtin.set_fact:
    runtime_specs:
      rust:
        check_path: "{{ ansible_env.HOME }}/.cargo/bin/rustc"
        installer_url: https://static.rust-lang.org/rustup/dist/x86_64-unknown-linux-gnu/rustup-init
        installer_dest: /tmp/rustup-init
        install_cmd: /tmp/rustup-init -y
        checksum: "sha256:https://static.rust-lang.org/rustup/dist/x86_64-unknown-linux-gnu/rustup-init.sha256"
      bun:
        check_path: "{{ ansible_env.HOME }}/.bun/bin/bun"
        installer_url: https://bun.sh/install
        installer_dest: /tmp/bun-install.sh
        install_cmd: /tmp/bun-install.sh
      uv:
        check_path: "{{ local_bin }}/uv"
        installer_url: https://astral.sh/uv/install.sh
        installer_dest: /tmp/uv-install.sh
        install_cmd: /tmp/uv-install.sh
      nvm:
        check_path: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
        installer_url: https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh
        installer_dest: /tmp/nvm-install.sh
        install_cmd: /tmp/nvm-install.sh
      starship:
        check_path: "{{ local_bin }}/starship"
        installer_url: https://starship.rs/install.sh
        installer_dest: /tmp/starship-install.sh
        install_cmd: "/tmp/starship-install.sh -y -b {{ local_bin }}"
      julia:
        check_path: ""  # Uses which instead
        check_cmd: julia
        installer_url: https://install.julialang.org
        installer_dest: /tmp/julia-install.sh
        install_cmd: /tmp/julia-install.sh -y

# ============================================================================
# Install runtimes using data-driven loop
# ============================================================================

- name: Install script-based runtimes
  ansible.builtin.include_tasks: install_runtime.yml
  loop: "{{ enabled_runtimes | map(attribute='name') | list }}"
  loop_control:
    loop_var: runtime_name
  when: runtime_name in runtime_specs

# ============================================================================
# Post-install: Node.js LTS via nvm
# ============================================================================

- name: Install Node.js LTS via nvm
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    nvm install --lts
  args:
    executable: /bin/bash
    creates: "{{ ansible_env.HOME }}/.nvm/versions/node"
  when:
    - enabled_runtimes | selectattr('name', 'equalto', 'nvm') | list | length > 0

# ============================================================================
# uv tools (Python CLI tools)
# ============================================================================

- name: Install uv tools (standard PyPI packages)
  ansible.builtin.shell: |
    {{ local_bin }}/uv tool install {{ item.name }}
  loop: "{{ uv_tools }}"
  when:
    - uv_tools is defined and uv_tools | length > 0
    - item.install | default(true)
    - item.name != 'mojo'
  loop_control:
    label: "{{ item.name }}"
  register: uv_tool_result
  changed_when: "'Installed' in uv_tool_result.stdout"

- name: Install Mojo via uv (requires Modular index)
  ansible.builtin.shell: |
    {{ local_bin }}/uv tool install mojo --index-url https://modular.gateway.scarf.sh/simple/ --index-strategy unsafe-best-match
  when:
    - uv_tools is defined
    - uv_tools | selectattr('name', 'equalto', 'mojo') | selectattr('install', 'defined') | selectattr('install', 'equalto', true) | list | length > 0 or
      uv_tools | selectattr('name', 'equalto', 'mojo') | rejectattr('install', 'defined') | list | length > 0
  register: mojo_result
  changed_when: "'Installed' in mojo_result.stdout"
  failed_when: false

# ============================================================================
# npm global packages
# ============================================================================

- name: Check if npm is available
  ansible.builtin.command:
    cmd: which npm
  register: npm_check
  changed_when: false
  failed_when: npm_check.rc > 1

- name: Check if nvm is installed
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
  register: nvm_installed

- name: Install npm global packages
  ansible.builtin.shell: |
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    if ! npm list -g {{ item.name }} --depth=0 >/dev/null 2>&1; then
      npm install -g {{ item.name }}{% if item.version is defined %}@{{ item.version }}{% endif %}

      echo "installed"
    else
      echo "already installed"
    fi
  args:
    executable: /bin/bash
  loop: "{{ npm_packages }}"
  when:
    - npm_packages is defined and npm_packages | length > 0
    - item.install | default(true)
    - npm_check.rc == 0 or nvm_installed.stat.exists
  loop_control:
    label: "{{ item.name }}"
  register: npm_result
  changed_when: "'installed' in npm_result.stdout"
