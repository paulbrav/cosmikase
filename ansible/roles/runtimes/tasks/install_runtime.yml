# Install a single runtime using the spec from runtimes_specs
# Variables: runtime_name (from loop), runtimes_specs (from main.yml)
---
- name: "Get spec for: {{ runtime_name }}"
  ansible.builtin.set_fact:
    runtimes_spec: "{{ runtimes_specs[runtime_name] }}"

- name: "Check if runtime is installed (path): {{ runtime_name }}"
  ansible.builtin.stat:
    path: "{{ runtimes_spec.check_path }}"
  register: runtimes_path_check
  when: runtimes_spec.check_path | length > 0

- name: "Check if runtime is installed (command): {{ runtime_name }}"
  ansible.builtin.command:
    cmd: "which {{ runtimes_spec.check_cmd }}"
  register: runtimes_cmd_check
  changed_when: false
  failed_when: runtimes_cmd_check.rc > 1
  when: runtimes_spec.check_cmd is defined

- name: "Set installation needed flag: {{ runtime_name }}"
  ansible.builtin.set_fact:
    runtimes_needs_install: >-
      {{ (runtimes_spec.check_path | length > 0 and not runtimes_path_check.stat.exists) or
         (runtimes_spec.check_cmd is defined and runtimes_cmd_check.rc != 0) }}

- name: "Download installer: {{ runtime_name }}"
  ansible.builtin.get_url:
    url: "{{ runtimes_spec.installer_url }}"
    dest: "{{ runtimes_spec.installer_dest }}"
    mode: "0755"
    checksum: "{{ runtimes_spec.checksum | default(omit) }}"
  when: runtimes_needs_install

- name: "Install runtime: {{ runtime_name }}"
  ansible.builtin.command:
    cmd: "{{ runtimes_spec.install_cmd }}"
  when: runtimes_needs_install
  changed_when: true

- name: "Clean up installer: {{ runtime_name }}"
  ansible.builtin.file:
    path: "{{ runtimes_spec.installer_dest }}"
    state: absent
  when: runtimes_needs_install
