# Ghostty role: Install Ghostty terminal emulator via Snap
---
# ============================================================================
# Snap Installation
# ============================================================================
# Using Snap package for reliable installation with bundled dependencies
# (including gtk4-layer-shell which isn't packaged on Ubuntu/Pop!_OS)

- name: Ensure snapd is installed
  become: true
  ansible.builtin.apt:
    name: snapd
    state: present

- name: Check if Ghostty snap is installed
  ansible.builtin.command:
    cmd: snap list ghostty
  register: ghostty_snap_check
  changed_when: false
  failed_when: false

- name: Install Ghostty via Snap
  become: true
  community.general.snap:
    name: ghostty
    classic: true
    state: present
  when: ghostty_snap_check.rc != 0

# ============================================================================
# Cleanup: Remove old source-built Ghostty if present
# ============================================================================

- name: Check for old source-built Ghostty binary
  ansible.builtin.stat:
    path: "{{ local_bin }}/ghostty"
  register: old_ghostty_binary

- name: Remove old source-built Ghostty binary
  ansible.builtin.file:
    path: "{{ local_bin }}/ghostty"
    state: absent
  when: old_ghostty_binary.stat.exists | default(false)

- name: Check for old Ghostty source directory
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/ghostty-source"
  register: old_ghostty_source

- name: Remove old Ghostty source directory
  ansible.builtin.file:
    path: "{{ ansible_env.HOME }}/ghostty-source"
    state: absent
  when: old_ghostty_source.stat.exists | default(false)
