#!/bin/bash
# Run after chezmoi apply to set up theme files and reload applications
# This script delegates to helper scripts for per-app theme updates

set -euo pipefail

THEME="{{ .theme }}"
THEMES_DIR="{{ .themes_dir }}"
THEME_PATH="$THEMES_DIR/$THEME"

echo "Setting up theme: $THEME"

# Ensure themes directory exists
if [[ ! -d "$THEMES_DIR" ]]; then
    echo "Warning: Themes directory not found at $THEMES_DIR"
    echo "Run 'make install' to sync themes from the repository."
    exit 0
fi

if [[ ! -d "$THEME_PATH" ]]; then
    echo "Warning: Theme '$THEME' not found in $THEMES_DIR"
    exit 0
fi

# Copy btop theme to btop themes directory
if [[ -f "$THEME_PATH/btop.theme" ]]; then
    mkdir -p ~/.config/btop/themes
    rm -f ~/.config/btop/themes/"$THEME.theme"
    cp "$THEME_PATH/btop.theme" ~/.config/btop/themes/"$THEME.theme"
    echo "  - Copied btop theme"
fi

# Copy opencode theme to opencode themes directory
if [[ -f "$THEME_PATH/opencode.json" ]]; then
    mkdir -p ~/.config/opencode/themes
    rm -f ~/.config/opencode/themes/"$THEME.json"
    cp "$THEME_PATH/opencode.json" ~/.config/opencode/themes/"$THEME.json"
    echo "  - Copied opencode theme"
fi

# Copy neovim theme
if [[ -f "$THEME_PATH/neovim.lua" ]] || [[ -f "$THEME_PATH/nvim.lua" ]]; then
    mkdir -p ~/.config/nvim/lua/omarchy_pop
    rm -f ~/.config/nvim/lua/omarchy_pop/theme.lua
    if [[ -f "$THEME_PATH/neovim.lua" ]]; then
        cp "$THEME_PATH/neovim.lua" ~/.config/nvim/lua/omarchy_pop/theme.lua
    elif [[ -f "$THEME_PATH/nvim.lua" ]]; then
        cp "$THEME_PATH/nvim.lua" ~/.config/nvim/lua/omarchy_pop/theme.lua
    fi
    echo "  - Copied neovim theme"
fi

# Find helper script (check common locations)
find_helper() {
    local name="$1"
    local locations=(
        "$HOME/.local/bin/$name"
        "/usr/local/bin/$name"
    )
    
    # Check if command is in PATH
    if command -v "$name" >/dev/null 2>&1; then
        command -v "$name"
        return
    fi
    
    # Check common locations
    for loc in "${locations[@]}"; do
        if [[ -x "$loc" ]]; then
            echo "$loc"
            return
        fi
    done
    
    echo ""
}

# Delegate to helper scripts if available
# These handle live app updates (COSMIC, terminals, etc.)

# Apply COSMIC theme (wallpaper, colors, terminal, dark/light mode)
COSMIC_HELPER=$(find_helper "omarchy-pop-theme-cosmic")
if [[ -n "$COSMIC_HELPER" ]]; then
    echo "  - Delegating COSMIC setup to helper..."
    THEMES_DIR="$THEMES_DIR" "$COSMIC_HELPER" "$THEME" --quiet || true
else
    # Fallback: inline COSMIC setup if helper not installed
    # This ensures theme works even without helper scripts
    
    # Set COSMIC wallpaper if available
    if [[ -d "$HOME/.config/cosmic" ]] && [[ -d "$THEME_PATH/backgrounds" ]]; then
        WALLPAPER=$(find "$THEME_PATH/backgrounds" -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" \) 2>/dev/null | head -1)
        if [[ -n "$WALLPAPER" ]]; then
            WALLPAPER=$(realpath "$WALLPAPER")
            COSMIC_BG_DIR="$HOME/.config/cosmic/com.system76.CosmicBackground/v1"
            mkdir -p "$COSMIC_BG_DIR"
            
            # Write proper RON format for wallpaper config
            cat > "$COSMIC_BG_DIR/all" << EOF
(
    output: "all",
    source: Path("$WALLPAPER"),
    filter_by_theme: false,
    rotation_frequency: 3600,
    filter_method: Lanczos,
    scaling_mode: Zoom,
    sampling_method: Alphanumeric,
)
EOF
            # Remove spurious source file if it exists
            rm -f "$COSMIC_BG_DIR/source"
            echo "  - Set COSMIC wallpaper"
        fi
    fi

    # Set COSMIC dark/light mode and apply theme
    if [[ -d "$HOME/.config/cosmic" ]]; then
        COSMIC_MODE_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Mode/v1"
        mkdir -p "$COSMIC_MODE_DIR"
        if [[ -f "$THEME_PATH/light.mode" ]]; then
            echo "false" > "$COSMIC_MODE_DIR/is_dark"
            echo "  - Set COSMIC to Light mode"
            # Copy light theme
            if [[ -f "$THEME_PATH/cosmic.ron" ]]; then
                COSMIC_THEME_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Light/v1"
                mkdir -p "$COSMIC_THEME_DIR"
                cp "$THEME_PATH/cosmic.ron" "$COSMIC_THEME_DIR/theme"
                echo "  - Applied COSMIC light theme"
            fi
        else
            echo "true" > "$COSMIC_MODE_DIR/is_dark"
            echo "  - Set COSMIC to Dark mode"
            # Copy dark theme
            if [[ -f "$THEME_PATH/cosmic.ron" ]]; then
                COSMIC_THEME_DIR="$HOME/.config/cosmic/com.system76.CosmicTheme.Dark/v1"
                mkdir -p "$COSMIC_THEME_DIR"
                cp "$THEME_PATH/cosmic.ron" "$COSMIC_THEME_DIR/theme"
                echo "  - Applied COSMIC dark theme"
            fi
        fi
        
        # Copy cosmic-term color scheme
        if [[ -f "$THEME_PATH/cosmic-term.ron" ]]; then
            COSMIC_TERM_DIR="$HOME/.config/cosmic/com.system76.CosmicTerm/v1"
            mkdir -p "$COSMIC_TERM_DIR"
            cp "$THEME_PATH/cosmic-term.ron" "$COSMIC_TERM_DIR/color_scheme"
            echo "  - Applied COSMIC terminal color scheme"
        fi
    fi
fi

# Reload terminal emulators
TERMINAL_HELPER=$(find_helper "omarchy-pop-theme-terminal")
if [[ -n "$TERMINAL_HELPER" ]]; then
    echo "  - Delegating terminal reload to helper..."
    "$TERMINAL_HELPER" --quiet || true
else
    # Fallback: inline terminal reload
    pkill -USR1 kitty 2>/dev/null || true
    pkill -USR1 ghostty 2>/dev/null || true
    echo "  - Reloaded terminals"
fi

# COSMIC uses inotify to watch config files - changes apply automatically

echo "Theme '$THEME' applied successfully!"
